# 30. 배포: Platform as a Service (Paas)

> ##### Paas에 종속되지 않도록 하자
>
> 호스팅 제공사에 따라 구조 변경이 생길 수 있는 아키텍처를 최대한 피하는 데 관심을 두어야 한다.  
> 한 호스팅 제공사에서 다른 제공사로 이전할 때 프로젝트의 주요 구성 자체를 변경하지 않고 이전할 수 있도록 준비해야 한다.  
> 다시 말하면 어느 특정 벤더의 가격, 약정, 기능에 매이지 않도록 하자는 것!

가장 일반적인 서비스 업체들

- 엘라스틱 빈스톡 [(https://aws.amazon.com/elasticbeanstalk/)](https://aws.amazon.com/elasticbeanstalk/)
- 허로쿠 [(http://heroku.com)](http://heroku.com)
- 파이썬애니웨어 [https://www.pythonanywhere.com](https://www.pythonanywhere.com)

## 30.1 Paas 선택하기

### 30.1.1 법적 제약

Paas를 선택할 때, 우선은 해당 PaaS 시스템이 각 지역 또는 국가별 법적 요구 조건을 충족하는지 여부를 확인하는 것이 중요하다.

### 30.1.2 가격

- 대부분의 Paas 옵션은 처음 시작하는 사용자나 토이 프로젝트에 대해 무료로 서비스를 제공한다.
- 추가적인 서비스를 합리적인 가격에 공급받을 수도 있다. 하지만 프로젝트와 서비스에 대한 주의를 게을리하면 어마어마한 월 사용 요금으로 커질 수 있다.
- Paas 업체 자체도 서비스 가격을 늘 똑같이 유지할 법적, 도덕적 책임이 없다는 것을 명심하자.

### 30.1.3 가동 시간

가동 시간이란 PaaS 업체에 매우 까다롭고 민감한 사안이다.

- 허로쿠와 파이썬애니웨어를 비롯한 PaaS 업체는 AWS나 Rackspace 같은 업체로 부터 공간을 임대한다. 따라서 해당 업체에 문제가 생겼을 경우, PaaS 업체들도 똑같이 문제를 겪게 된다.
- 모든 시설은 물리적 인프라스트럭처에 기반을 둔 인터넷에 존재한다. 자연재해나 산업 사고 때문에 모든 것이 중지될 수도 있다.

> ##### 매우 높은 수준의 가용성을 필요로 한다면
> 실제 사람의 생명과도 연관되는 프로젝트의 경우, PaaS는 그다지 추천할 만한 방안은 아니다.

### 30.1.4 PaaS 회사의 인력 배치

- PaaS에 직원이 부족할 경우, 특히 휴일 동안 연중무휴 24x7 엔지니어링 지원을 제공할 수 없다.
- 이메일과 문제 티켓에 대응할 전담 직원이 있는가? 엔지니어가 해당 이메일과 문제 티켓에 대응을 한다면 언제 시스템을 유지, 관리, 발전시키겠는가?

### 30.1.5 스케일링

- 얼마나 손쉽게 스케일 업/다운이 가능한가?
- 스케일링 프로세스를 자동화 할 수 있는가?

### 30.1.6 HTTP Server

- 대부분의 Python 친화적인 서비스들은 Nginx나 자체적인 유사 시스템을 사용하여 데이터를 제공하며, 모두 WSGI를 이용할 수 있다.
- 일부의 PaaS는 WSGI만 지원하므로 Django Channels를 사용할 수 없다.

> 책의 출판 당시에 Elastic Beanstalk는 아파치 mod_wsgi를 사용한다. Django Channels를 반드시 사용해야 한다면 Elastic Beanstalk를 사용하면 안된다.

### 30.1.7 문서화

- 잘 정리되고 꾸진히 관리되는 서비스가 그렇지 않은 서비스보다 더 반갑게 느껴지고 선호된다.
- 이러한 문서를 제공하는 것은 PaaS 업체가 자신들의 업무를 얼마나 진지하게 생각하고 있는지를 나타내는 증거이기도 하다.

### 30.1.8 성능저하

- 성능이 저하될만한 커밋 이력을 살펴본다.
- 발견되지 않은 병목현상을 조사해보자. (24장 참고)
- PaaS 지원팀에 해당 문제에 대한 질문을 해본다.
- 프로젝트가 구동되고 있는 물리적 하드웨어 자체의 문제일 수 있다. 새로운 프로젝트 인스턴스를 띄워본다.

### 30.1.9 지리적 요건

- PaaS 서비스의 위치와 서비스가 주로 사용될 장소를 고려해야한다.

### 30.1.10 회사의 안정성

- PaaS 서비스는 해결해야 할 문제가 한 두 가지가 아니다. PaaS 업체가 베타 기간이나 초기 시작 기간을 지났는데도 이익을 낼 수 없다면 해당 업체를 이용하는 것은 위험한 일이다.

## 30.2 PaaS로 배포하기

### 30.2.1 동일한 환경을 목표로 잡는다

- 배포의 핵심은 개발 환경과 상용 환경을 완전히 똑같이 맞추는 것 -> 프로젝트를 좀 더 잘 관리할 수 있음.
- 운영 환경의 문제를 재현하는 최선의 방법은 로컬 환경에서 직접 운영 환경에 준하는 리눅스를 돌려 보는 것. (2.5장 참고)

### 30.2.2 스테이징 인스턴스 관리하기

- 스테이징 환경은 상용 환경에서의 배포를 테스트할 수 있는 최적의 장소이며, 기능 변경에 따른 데모 환경으로도 좋다.


### 30.2.3 모든 것을 자동화하기

- Makefiles: 간단한 프로젝트에는 매우 유용하다. 기능이 제한되어 있으므로, 너무 복잡하게 시스템을 꾸미는 것을 방지해 준다.
- Invoke: 잘 알려진 Fabric 라이브러리의 대를 잇는 도구. 로컬 환경에서 태스크를 실행하는 기능을 가지고 있다.

### 30.2.4 여러개의 환경을 위한 여러개의 requirements 파일

모든 곳에서 동일한 환경으로 제한되는 것이 좋을 수 있지만, 어떤 상황에서는 다른 장소에 다른 버전의 소프트웨어가 필요하다.  
(e.g. 프로덕션 환경은 Django 1.11.3을 실행하고 스테이징 환경은 Django 1.11.5를 실행)  
이러한 경우에는 자동화와 환경별로 분리된 requirements 파일을 이용한다.  
(e.g. requirments/staging.txt, requirements/production.txt)

### 30.2.5 백업과 롤백으로 장애 대비하기

때로는 배포로 인해 모든 것을 날릴 수도 있다. 변경사항을 프로덕션 환경으로 반영하기 전에, 다음 기능을 어떻게 해당 PaaS 시스템에서 이용할 수 있는지 확인해야한다.

- 백업으로부터 DB와 사용자 업로드 파일을 복구하기
- 이전 코드 푸시로 롤백하기

### 30.2.6 외부 백업 유지하기

PaaS에서 백업을 생성하는 기능을 제공하는데, 이에 추가해서 외부 서비스로 주기적인 백업을 하는 것을 고려해보도록 한다. 이러한 백업에는 DB 파일과 사용자가 올린 파일들이 포함되어야 할 것이다.

## 30.3 요약

- PaaS는 신속하게 프로젝트를 배포하는 데 최상의 도구이다.
- PaaS 서비스 이용 결정은 프로젝트에 따라, 이용 가능한 기술에 따라 결정되어야 한다.


