# 32. 지속적 통합

- Martin Fowler는 지속적 통합(continuous integration, CI) 개념을 처음 제안한 사람 중 한 명이다.
- Martin Fowler는 아래와 같이 이야기 했다.

> 지속적 통합은 소프트웨어 개발 방법론의 하나로 팀원들이 자신의 작업 내용을 적어도 하루에 한 번 이상 시스템에 적용하는 방법이다.
> 각 팀원이 하루에 한 번 이상이라는 것은 결국 시스템 전체로 보면 하루에 여러 번 코드가 적용됨을 의미한다.
> 각 개발자의 코드는 자동화된 (테스트를 포함한) 빌드 절차를 통해 검증되어 문제점이 빨리 발견된다.
> 많은 팀이 이러한 방법을 통해 코드 통합 단계에서 문제점을 줄이고 빠르게 소프트웨어를 통합할 수 있게 되었다. 

[Martin Fowler의 블로그](https://martinfowler.com/articles/continuousIntegration.html)

- 지속적 통합을 이용한 일반적인 개발 workflow
1. 개발자가 코드를 작성하고 해당 코드에 대한 로컬 테스트를 진행. 작성한 코드를 GitHub나 GitLab 저장소로 push. 적어도 하루에 한 번 이상 이런 작업을 진행.
2. 코드 저장소는 새로운 코드가 들어오면 통합될 commit이 있다고 자동화 도구에 알려준다.
3. 자동화 시스템이 코드를 프로젝트에 넣고 빌드를 진행. 빌드 과정 중 빌드 실패가 발생하면 해당 코드의 commit 거부.
4. 자동화 시스템이 개발자가 작성한 테스트를 실행. 테스트 실패 시 commit 거부.
5. 개발자들은 자기 코드가 성공 또는 실패 정보(실패 시 세부 정보 포함한)를 전달 받음. 전달 내용을 바탕으로 문제 해결. 문제점이 없으면 다음 작업 고고

- 지속적 통합의 효과
1. 문제점이나 버그에 대한 조기 경고
2. 코드 배포에 관련된 문제점을 자주 발견
3. 코드는 매일 지속적으로 통합이 되기 때문에 큰 문제가 발생하지 않음.
4. 즉각적인 코드 피드백이 가능
5. 개발자와 매니저 둘 다에게 도움이 되는 시스템과 코드의 상태를 정보를 제공


## 32.1 지속적 통합의 원칙

- Martin Fowler의 의견임.

### 32.1.1 다양한 테스트 케이스를 작성하라

- 테스트 없이 지속적 통합을 하여 배포가 성공적으로 이루어지고, 하나의 브랜치를 공유하게 되니 필요없다고 하지만
이는 정적 타이핑을 지원하는 언어의 입장이다. 이러한 언어는 컴파일이 성공했다는 것은 기능상 해당 소프트웨어가 작동한다는 것을 보장하기 때문이다.

### 32.1.2 지속적이면 빠른 빌드를 한다.

- 테스트 케이스는 상용 서비스에서 사용하는 같은 DB를 이용하여 테스트를 해야 한다.
- 하지만 특정 경우에는 테스트 자체가 오래 걸리 수 있고, 이 것은 부담이 될 수 있다.
- 빠른 테스트를 위해 SQLite3를 이용할 수 도 있다. 하지만 SQLite3은 PostgerSQL이나 MySQL과 다르기 때문에 문제가 발생 할 수도 있다.

- 테스트 속도를 높이는 몇 가지 tip
    - Fixture 이용을 자제
    - 반드시 필요한 경우가 아니라면 TransactionTestCase 이용을 자제
    - 과도한 setUp() 메서드 자제
    - 빠른 속도를 염두에 둔 작은 테스트를 주로 작성하고, 통합형 테스트를 추가
    - 테스트를 위해 DB를 어떻게 최적화할지 공부한다. (https://stackoverflow.com/questions/9407442/optimise-postgresql-for-fast-testing/9407940#9407940)


## 32.2 지속적으로 프로젝트를 통합하기 위한 도구들

### 32.2.1 Tox

- [Tox](https://tox.readthedocs.io/)
- Tox는 virtualenv 관리 도구로 shell에서 단일 명령을 이용하여 여러 버전의 Python과 여러 버전의 Django에 대해 프로젝트를 테스트하게 해준다.
- 또한 다양한 종류의 DB엔진을 테스트할 수 도 있다.

### 32.2.2 Jenkins

- [Jenkins](https://jenkins.io/)
- 프라이빗 소스와 오픈 소스의 노력이 같이 섞인 도구
- 상당히 큰 커뮤니티와 생태계를 구축하고 있는 지속적 통합 자동화 도구의 표준
- Jenkins 이외의 다른 대안을 고려하고 있다면 신중하게 생각해라.


## 32.3 서비스로서 지속적 통합

- Jenkins를 세팅하고 대신 실행해주는 서비스가 있다.
- 대부분의 서비스들이 오픈 소스 저장소에서 무료 서비스를 제공한다.
- 다음은 필자가 좋아하는 서비스 업체(CI Services) 리스트이다.

| 서비스              | 지원하는 Python 버전             | 링크                       |
|--------------------|-------------------------------|---------------------------|
| Travis-CI          | 3.6, 3.5, 3.4, 3.3, 2.7, PyPy | https://travis-ci.org/    |
| AppVeyor (Windows) | 3.6, 3.5, 3.4, 3.3, 2.7       | https://www.appveyor.com/ |
| GitLab             | 3.6, 3.5, 3.4, 3.3, 2.7, PyPy | https://about.gitlab.com/ |

### 32.3.1 서비스로서의 코드 커버리지

- CI Services 를 이용하게 되면 코드 커버리지를 다룰 수 없는 문제가 발생한다. (22.7장의 테스트 범위 게임)
- codecov.io 같은 서비스를 통하면 커버리지 보고를 생성 할 수 있다.

